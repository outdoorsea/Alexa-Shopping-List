# Alexa Shopping List MCP Server

This project provides a [FastMCP](https://github.com/jlowin/fastmcp) server that allows an LLM (like Claude) to interact with your Alexa shopping list via the Model Context Protocol (MCP).

## Features

- Provides MCP tools to:
    - Get the current shopping list (`get_list`).
    - Add one or more items (`add_item`).
    - Delete one or more items by value (`delete_item`).
    - Mark one or more items as complete by value (`mark_complete`).
    - Mark one or more items as incomplete by value (`mark_incomplete`).
    - Clear all completed items from the list (`clear_completed_items`).
- Uses Selenium **in a separate step** to handle the initial Amazon login (including 2FA) and save authentication cookies.
- The MCP server loads the saved cookies to make authenticated API calls.

## Prerequisites

- Python 3.x and pip.
- **Google Chrome** (or another supported browser) installed on the host machine for the initial login step.
- An Amazon account with Alexa enabled.
- `fastmcp` installed (`pip install fastmcp`).

## Setup

### 1. Install Dependencies

```bash
pip install -r requirements.txt
```
This installs `requests`, `python-dotenv`, `selenium`, `webdriver-manager`, and `fastmcp`.

### 2. Environment Variables

Create a `.env` file in the project root. Populate it with:

```dotenv
# Your local Amazon domain (e.g., amazon.com, amazon.co.uk)
AMAZON_URL=https://www.amazon.com

# Path where the login script will SAVE and the MCP server will READ the cookie file.
# Ensure the directory exists if not using the current directory.
COOKIE_PATH=./alexa_cookie.pickle

# Logging level for the scripts (DEBUG, INFO, WARNING, ERROR, CRITICAL)
LOG_LEVEL=INFO
```

### 3. Authentication (Cookie Generation - Run Once or When Needed)

The MCP server itself does **not** handle the browser login. You need to run the `run.py` script to handle the authentication flow and generate the cookie file the server needs.

1.  **Configure `.env`:** Ensure your `.env` file is correctly set up with `AMAZON_URL` and `COOKIE_PATH`.
2.  **Run the Login Script:** Execute `run.py` from your terminal in the project root directory.
    ```bash
    python run.py
    ```
3.  **Browser Interaction:**
    *   The script will inform you it's starting the process.
    *   If an old cookie file exists at `COOKIE_PATH`, it will be deleted.
    *   Selenium will download the appropriate WebDriver if needed.
    *   A browser window (e.g., Chrome) will open to your `AMAZON_URL`.
    *   **MANUALLY** log in to your Amazon account in that browser window. Enter your email, password, and complete any 2FA steps.
    *   Once fully logged in on the main Amazon page, switch back to the console where `run.py` is running.
    *   Press `Enter` in the console.
4.  **Cookie Saved:** The script extracts cookies and saves them to the path specified by `COOKIE_PATH` in your `.env` file. The browser closes, and the script confirms success or failure.

You only need to run `python run.py` when the cookie file doesn't exist or has expired.

## Running the MCP Server

Once the cookie file has been successfully generated by `run.py`:

### Option 1: Development Mode (Testing)

Use `fastmcp dev` to run the server locally and access the MCP Inspector web UI for manual tool testing.

```bash
# 1. Run 'python run.py' first if cookie is missing/expired
# 2. Then run the dev server:
fastmcp dev src.mcp.mcp_server
```
Open the URL provided in your browser.

### Option 2: Claude Desktop Integration

Use `fastmcp install` to make the server available within the Claude Desktop application.

```bash
# 1. Run 'python run.py' first if cookie is missing/expired
# 2. Then install the server:
fastmcp install src.mcp.mcp_server --name "Alexa Shopping List"
```
This command handles creating an isolated environment and registering the server.

### Option 3: Direct Execution (Advanced)

Run the server script directly if integrating with a custom application.

```bash
# 1. Run 'python run.py' first if cookie is missing/expired
# 2. Then run the server directly:
python src/mcp/mcp_server.py
```
The server will run using the default transport (usually stdio).

## Troubleshooting

- **MCP Server Connection/API Issues:** Ensure `fastmcp` is installed. Verify the cookie file (`COOKIE_PATH`) exists and is valid (regenerate it by running `python run.py`). Check the server logs for errors.
- **Login/WebDriver Errors (During `python run.py`):** Ensure Google Chrome is installed and up-to-date. `webdriver-manager` usually handles driver versions, but sometimes manual intervention or clearing its cache (`~/.wdm`) might be needed. Check error logs from `run.py`.
- **Cookie Extraction Failure (During `python run.py`):** Make sure you fully complete the login (including 2FA) in the browser *before* pressing Enter in the console when prompted by `run.py`.
- **Expired Cookies:** If the MCP server starts failing API calls (e.g., cannot retrieve list), the cookies have likely expired. Delete the cookie file and re-run `python run.py` to authenticate again.
- **`spawn uv ENOENT` Error (During Claude Desktop use):** This error in the Claude Desktop logs means it cannot find the `uv` executable. The `fastmcp install` command relies on `uv` to manage the server's environment. Install `uv` globally using `pipx install uv` or `brew install uv` and ensure it's in your system's PATH. Restart Claude Desktop after installation.
